apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: mutate-gpu-toleration-request
spec:
  mutateExistingOnPolicyUpdate: true
  rules:
    - name: mutate-gpu-toleration-request
      match:
        any:
        - resources:
            kinds:
            - Pod
            namespaces:
            - frederik-coquelet
      preconditions:
        any:
        - key: "{{ request.object.spec.nodeSelector.\"nvidia.com/gpu\" || ''}}"
          operator: Equals
          value: "true"
      mutate:
        targets:
        - apiVersion: v1
          kind: Pod
          namespace: frederik-coquelet
        patchesJson6902: |-
          - op: add
            path: "/spec/tolerations/-"
            value: {"key":"local-node","operator":"Exists","effect":"NoSchedule"}        