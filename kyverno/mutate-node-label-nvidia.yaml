apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: label-nodes-nvidia
  namespace: kyverno
         
spec:
  mutateExistingOnPolicyUpdate: true
  rules:
    - name: label-node-nvidia
      match:
        any:
          - resources:
              kinds:
              - Node
              names: 
              - kubefred
      mutate:
        targets:
        - apiVersion: v1
          kind: Node
          name: "{{ request.object.metadata.name }}"
        patchStrategicMerge:
          metadata:
            labels:
              feature.node.kubernetes.io/pci-10de.present: 'true'
              nvidia.com/device-plugin.config: 'RTX-3060' # needed because GFD is not available
              nvidia.com/gpu.count: '1'
              nvidia.com/gpu.deploy.container-toolkit: 'false'
              nvidia.com/gpu.deploy.dcgm: 'true' # optional
              nvidia.com/gpu.deploy.dcgm-exporter: 'false' # optional
              nvidia.com/gpu.deploy.device-plugin: 'true' 
              nvidia.com/gpu.deploy.driver: 'false' # need special treatments
              nvidia.com/gpu.deploy.gpu-feature-discovery: 'false' # incompatible with WSL2
              nvidia.com/gpu.deploy.node-status-exporter: 'false' # optional
              nvidia.com/gpu.deploy.operator-validator: 'true'
              nvidia.com/gpu.present: 'true'
              nvidia.com/gpu.replicas: '4'