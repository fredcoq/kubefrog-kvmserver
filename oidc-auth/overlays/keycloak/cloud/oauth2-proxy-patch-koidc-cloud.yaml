apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: oauth2-proxy-cloud
  namespace: argocd
spec:
  project: default
  source:
    source:
    chart: oauth2-proxy
    repoURL: https://oauth2-proxy.github.io/manifests
    targetRevision: "7.10.4"
    helm:
      parameters:
      - name: serviceAccount.enabled
        value: 'false'   # we will create the ServiceAccount manually.
      - name: serviceAccount.name
        value: oauth2-proxy
      - name: prompt
        value: none
      - name: image.repository
        value: quay.io/oauth2-proxy/oauth2-proxy
      - name: image.tag
        value: v7.8.1
      - name: configSecret.create
        value: 'false'
      - name: config.existingSecret
        value: oauth2-proxy
      - name: service.portNumber
        value: '4180'
      - name: extraArgs.provider
        value: keycloak-oidc
      - name: extraArgs.set-xauthrequest
        value: 'true'
      - name: extraArgs.set-authorization-header
        value: 'true'
      - name: extraArgs.cookie-secure
        value: 'true'
      - name: extraArgs.cookie-samesite
        value: lax
      - name: extraArgs.cookie-csrf-per-request
        value: 'true'
      - name: extraArgs.cookie-csrf-expire
        value: 5m
      - name: extraArgs.cookie-refresh
        value: 30m
      - name: api_routes[0] 
        value: "/api/"
      - name: api_routes[1]
        value: "/apis/"
      - name: api_routes[2]
        value: "^/ml_metadata"
      - name: extraArgs.cookie-expire
        value: 168h
      - name: extraArgs.cookie-name
        value: _oauth2_proxy
      - name: extraArgs.email-domain
        value: '*'
      - name: extraArgs.upstream
        value: static://200
      - name: extraArgs.skip-provider-button
        value: 'true'
      - name: extraArgs.ssl-upstream-insecure-skip-verify
        value: 'true'
      - name: extraArgs.ssl-insecure-skip-verify
        value: 'true'
      - name: extraArgs.cookie-domain
        value: .kubefrog.ai
      - name: extraArgs.whitelist-domain
        value: .kubefrog.fr
      - name: extraArgs.session-store-type
        value: redis
      - name: extraArgs.redirect-url
        value: https://kubeflow.kubefrog.ai/oauth2/callback
      - name: extraArgs.oidc-issuer-url
        value: https://auth-kvm.kubefrog.fr/realms/kubeflow    
      - name: extraArgs.scope
        value: "openid" # profile email groups"
      - name: sessionStorage.type
        value: redis
      - name: sessionStorage.redis.clientType
        value: standalone
      - name: sessionStorage.redis.existingSecret
        value: oauth2-proxy-redis
      - name: sessionStorage.redis.standalone.connectionUrl
        value: redis://oauth2-proxy-cloud-redis-master:6379
      - name: redis.enabled
        value: 'true'
      - name: redis.architecture
        value: standalone
      - name: redis.auth.existingSecret
        value: oauth2-proxy-redis
      - name: redis.auth.existingSecretPasswordKey
        value: redis-password
      - name: extraArgs.extra-jwt-issuers
        value: "https://kubernetes.default.svc.cluster.local=https://kubernetes.default.svc.cluster.local"
      - name: extraArgs.skip-jwt-bearer-tokens
        value: 'true'
      - name: initContainers.waitForRedis.securityContext.runAsUser
        value: '1337'
      - name: initContainers.waitForRedis.securityContext.runAsGroup
        value: '1337'

  destination:
    namespace: auth
    server: https://kubernetes.default.svc
    
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true