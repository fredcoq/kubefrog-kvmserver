apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: keycloak
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://charts.bitnami.com/bitnami
    targetRevision: 10.1.5
    chart: keycloak
    helm:
      parameters:
      - name: image.tag
        value: 18.0.2
      - name: auth.adminUser
        value: admin
      - name: auth.managementUser
        value: manager
      - name: proxyAddressForwarding
        value: 'true'
      - name: auth.existingSecret
        value: keycloak-secret
      - name: postgresql.auth.existingSecret
        value: keycloak-postgresql
      - name: extraVolumeMounts[0].name
        value: config
      - name: extraVolumeMounts[0].mountPath
        value: /data/import
      - name: extraVolumeMounts[0].readOnly
        value: 'true'
      - name: extraVolumes[0].name
        value: config
      - name: extraVolumes[0].secret.secretName
        value: kubeflow-realm
      - name: extraVolumeMounts[1].name
        value: keycloak-theme
      - name: extraVolumeMounts[1].mountPath
        value: /opt/bitnami/keycloak/themes/kubeflow/login/
      - name: extraVolumeMounts[1].subPath
        value: kubeflow
      - name: extraVolumeMounts[2].name
        value: keycloak-theme
      - name: extraVolumeMounts[2].mountPath
        value: /opt/bitnami/keycloak/themes/keywind/login/
      - name: extraVolumeMounts[2].subPath
        value: keywind
      - name: extraVolumes[1].emptyDir.sizeLimit
        value: 100Mi
      - name: extraVolumes[1].name
        value: keycloak-theme        
      - name: extraEnvVars[0].name
        value: KEYCLOAK_EXTRA_ARGS
      - name: extraEnvVars[0].value
        value: "-Dkeycloak.import=/data/import/kubeflow-realm.json"
      - name: extraEnvVars[1].name
        value: KEYCLOAK_EXTRA_ARGS
      - name: extraEnvVars[1].value
        value: "--spi-login-protocol-openid-connect-legacy-logout-redirect-uri=true"
      - name: podLabels.app
        value: "keycloak"
      - name: service.type
        value: ClusterIP
      - name: service.port
        value: '8080'
      - name: service.httpsPort
        value: '8443'
      - name: metrics.enabled
        value: 'true'
      - name: metrics.serviceMonitor.enabled
        value: 'false'
      - name: metrics.serviceMonitor.namespace
        value: monitoring
# initi container that will import the theme from minio to keycloak
# minio is at host adress 192.168.0.200:9000
      #- name: initContainers[0].volumeMounts[0].name
      #  value: keycloak-theme
      #- name: initContainers[0].volumeMounts[0].mountPath
      #  value: /tmp/theme
      #- name: initContainers[0].name
      #  value: keycloak-theme
      #- name: initContainers[0].image
      #  value: minio/mc:latest
      #- name: initContainers[0].imagePullPolicy
      #  value: IfNotPresent
      #- name: initContainers[0].command[0]
      #  value: 'sh'
      #- name: initContainers[0].command[1]
      #  value: '-c'
      #- name: initContainers[0].command[2]
      #  value: 'mc alias set syno http://192.168.0.200:9000 minioadmin minioadmin && mc cp -r syno/keycloak-theme/kubeflow /tmp/theme && mc cp -r syno/keycloak-theme/keywind /tmp/theme'


  
  destination:
    server: https://kubernetes.default.svc
    namespace: auth
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
