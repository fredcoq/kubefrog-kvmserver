apiVersion: data.fluid.io/v1alpha1
kind: Dataset
metadata:
  name: s3-data-llm-models
  namespace: frederik-coquelet
spec:
  mounts:
    - mountPoint: "s3://model/TheBloke_Llama-2-7b-Chat-GPTQ/"
      name: TheBloke_Llama-2-7b-Chat-GPTQ
      path: /TheBloke_Llama-2-7b-Chat-GPTQ
      options:
        alluxio.underfs.s3.secure.http.enabled: "false"
        alluxio.underfs.s3.endpoint: "http://192.168.0.200:9000"
        alluxio.underfs.s3.disable.dns.buckets: "true"
        alluxio.underfs.s3.inherit.acl: "false"
      encryptOptions:
        - name: s3a.accessKeyId
          valueFrom:
            secretKeyRef:
              name: s3creds
              key: AWS_ACCESS_KEY_ID
        - name: s3a.secretKey
          valueFrom:
            secretKeyRef:
              name: s3creds
              key: AWS_SECRET_ACCESS_KEY
    - mountPoint: "s3://model/TheBloke_Phind-CodeLlama-34B-v2-GPTQ_gptq-3bit--1g-actorder_True/"
      name: TheBloke_Phind-CodeLlama-34B-v2-GPTQ
      path: /TheBloke_Phind-CodeLlama-34B-v2-GPTQ
      options:
        alluxio.underfs.s3.secure.http.enabled: "false"
        alluxio.underfs.s3.endpoint: "http://192.168.0.200:9000"
        alluxio.underfs.s3.disable.dns.buckets: "true"
        alluxio.underfs.s3.inherit.acl: "false"
      encryptOptions:
        - name: s3a.accessKeyId
          valueFrom:
            secretKeyRef:
              name: s3creds
              key: AWS_ACCESS_KEY_ID
        - name: s3a.secretKey
          valueFrom:
            secretKeyRef:
              name: s3creds
              key: AWS_SECRET_ACCESS_KEY
    - mountPoint: "s3://model/test"
      name: test
      path: /test
      options:
        alluxio.underfs.s3.secure.http.enabled: "false"
        alluxio.underfs.s3.endpoint: "http://192.168.0.200:9000"
        alluxio.underfs.s3.disable.dns.buckets: "true"
        alluxio.underfs.s3.inherit.acl: "false"
      encryptOptions:
        - name: s3a.accessKeyId
          valueFrom:
            secretKeyRef:
              name: s3creds
              key: AWS_ACCESS_KEY_ID
        - name: s3a.secretKey
          valueFrom:
            secretKeyRef:
              name: s3creds
              key: AWS_SECRET_ACCESS_KEY
    
  accessModes:
    - ReadOnlyMany
  tolerations:
    - key: "local-node"
      operator: "Exists"
      effect: "NoSchedule"
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - "ubuntu-gpu-wk"
  placement: "Shared"
---
apiVersion: data.fluid.io/v1alpha1
kind: AlluxioRuntime
metadata:
  name: s3-data-llm-models
  namespace: frederik-coquelet
spec:
  replicas: 1
  properties:
    alluxio.user.ufs.block.read.location.policy: alluxio.client.block.policy.LocalFirstAvoidEvictionPolicy
    alluxio.user.block.size.bytes.default: 256MB
    alluxio.user.streaming.reader.chunk.size.bytes: 256MB
    alluxio.user.local.reader.chunk.size.bytes: 256MB
    alluxio.worker.network.reader.buffer.size: 256MB
    alluxio.user.streaming.data.timeout: 300sec
  tieredstore:
    levels:
      - mediumtype: SSD
        path: /mnt/ssd0/cache
        quota: 20Gi
        high: "0.95"
        low: "0.7"
  master:
    nodeSelector:
      kubernetes.io/hostname: ubuntu-gpu-wk

