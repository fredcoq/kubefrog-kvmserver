apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  namespace: istio-system
  name: istio
spec:
  tag: 1.23.6 # istio/operator
  hub: docker.io/istio
  meshConfig:
    accessLogEncoding: TEXT # JSON
    accessLogFile: /dev/stdout
    enablePrometheusMerge: true
    enableTracing: true
    defaultConfig:
      proxyMetadata:
        ISTIO_META_ENABLE_HBONE: "true"
      tracing:
        sampling: 10.0
        max_path_tag_length: 256
        zipkin:
          address: simple-prod-collector.monitoring.svc.cluster.local:9411
      gatewayTopology:
        numTrustedProxies: 3
    extensionProviders:
    - name: oauth2-proxy
      envoyExtAuthzHttp:
        service: oauth2-proxy.auth.svc.cluster.local
        port: '4180' # The default port used by oauth2-proxy.
        #includeHeadersInCheck: ["authorization", "cookie"]  # headers sent to the oauth2-proxy in the check request.
        includeHeadersInCheck: # headers sent to the oauth2-proxy in the check request.
            # https://github.com/oauth2-proxy/oauth2-proxy/issues/350#issuecomment-576949334
        - cookie
        - authorization

        headersToUpstreamOnAllow: [authorization, kubeflow-userid, x-forwarded-for, path, x-auth-request-user, x-auth-request-email, x-auth-request-access-token, x-auth-request-groups]             # headers sent to backend application when request is allowed.
        headersToDownstreamOnDeny: [content-type, set-cookie]     # headers sent back to the client when request is denied.
    - name: oauth2-proxy-cloud
      envoyExtAuthzHttp:
        service: oauth2-proxy-cloud.auth.svc.cluster.local
        port: '4180' # The default port used by oauth2-proxy.
        #includeHeadersInCheck: ["authorization", "cookie"]  # headers sent to the oauth2-proxy in the check request.
        includeHeadersInCheck: # headers sent to the oauth2-proxy in the check request.
            # https://github.com/oauth2-proxy/oauth2-proxy/issues/350#issuecomment-576949334
        - cookie
        - authorization
    
        headersToUpstreamOnAllow: [authorization, x-forwarded-for, path, x-auth-request-user, x-auth-request-email, x-auth-request-groups]             # headers sent to backend application when request is allowed.
        headersToDownstreamOnDeny: [content-type, set-cookie]     # headers sent back to the client when request is denied.
  
  components:
    cni:
      enabled: true
      
      
    ztunnel:
      enabled: false
    ingressGateways:
    - name: istio-ingressgateway
      enabled: true
      k8s: 
        service:
          type: LoadBalancer
          loadBalancerIP: 172.22.80.100
          ports:
           - name: postgres
             port: 5432
             protocol: "TCP"
             targetPort: 5432
           - name: https
             port: 443
             protocol: "TCP"
             targetPort: 8443
           - name: http
             port: 80
             protocol: "TCP"
             targetPort: 8080


          externalTrafficPolicy: Local
        #serviceAnnotations:
        #  proxy.istio.io/config: '{"gatewayTopology" : { "numTrustedProxies": 2 } }'    
          
  # Cluster-local gateway for KFServing
    - enabled: true
      name: cluster-local-gateway
      # https://github.com/istio/istio/issues/19263#issuecomment-615833092
      label:
        app: cluster-local-gateway
        istio: cluster-local-gateway
      k8s:
        env:
        - name: ISTIO_META_ROUTER_MODE
          value: sni-dnat
        hpaSpec:
          maxReplicas: 1
          metrics:
          - resource:
              name: cpu
              target:
                type: Utilization
                averageUtilization: 80
            type: Resource
          minReplicas: 1
          scaleTargetRef:
            apiVersion: apps/v1
            kind: Deployment
            name: cluster-local-gateway
        resources:
          limits:
            cpu: 2000m
            memory: 1024Mi
          requests:
            cpu: 100m
            memory: 128Mi
        service:
          type: ClusterIP
          ports:
          - name: status-port
            port: 15020
            targetPort: 15020
          - name: http2
            port: 80
            targetPort: 8080

    # Disable EgressGateway
    egressGateways:
    - enabled: false
      name: istio-egressgateway
  values:
    profile: ambient
    cni:
      repair:
        deletePods: true
        repairPods: false     
    global:
      proxy:
        resources:
          requests:
            cpu: 10m
            memory: 128Mi
          limits:
            cpu: 2000m
            memory: 1024Mi
      meshID: mesh-default
      network: mesh
      multiCluster:
        clusterName: cluster-local
      operatorManageWebhooks: true
      pilotCertProvider: istiod
      proxy_init:
        resources:
          limits:
      tracer:
        zipkin:
          address: simple-prod-collector.monitoring.svc.cluster.local:9411
      istiod:
        enableAnalysis: true # see https://istio.io/latest/docs/reference/config/config-status/
    sidecarInjectorWebhook:
      neverInjectSelector:
      # kube-prometheus-stack
      ## Admission Webhook jobs do not terminate as expected with istio-proxy
      - matchExpressions:
        - {key: app, operator: In, values: [kube-prometheus-stack-admission-create, kube-prometheus-stack-admission-patch, alertmanager]}
    
    pilot:
      autoscaleEnabled: true
      autoscaleMax: 2
      autoscaleMin: 1
      configMap: true
      cpu:
        targetAverageUtilization: 80
      env:
        PILOT_ENABLE_STATUS: true # see https://istio.io/latest/docs/reference/config/config-status/
        PILOT_ENABLE_CONFIG_DISTRIBUTION_TRACKING: true
        PILOT_ENABLE_AMBIENT: true
        PILOT_JWT_PUB_KEY_REFRESH_INTERVAL: "1m"
